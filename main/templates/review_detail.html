{% extends 'base.html' %}
{% load static %}
{% block title %}{{ review.place_name }} Review | Ben's Breads{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="container py-4">
    <!-- Navigation and Actions -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <a href="{% url 'reviews' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Reviews
          </a>
          
          {% if user.is_staff or user.is_superuser %}
            <div class="d-flex gap-2">
              <a href="{% url 'edit_review' review.id %}" class="btn btn-outline-primary">
                <i class="fas fa-edit me-1"></i>Edit Review
              </a>
              <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteReviewModal">
                <i class="fas fa-trash me-1"></i>Delete Review
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-lg-10">
        <!-- Main Review Card -->
        <div class="review-detail-card">
          <div class="row g-0">
            <!-- Review Info -->
            <div class="col-12">
              <div class="review-info-section">
                <!-- Review Title -->
                <div class="review-title-section mb-4">
                  <h2 class="review-card-title">{{ review.place_name }}</h2>
                  <div class="reviewer-info">
                    <div class="reviewer-avatar">
                      <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="reviewer-details">
                      <span class="reviewer-name">
                        {% if review.author.first_name and review.author.last_name %}
                          {{ review.author.first_name }} {{ review.author.last_name }}
                        {% else %}
                          {{ review.author.username }}
                        {% endif %}
                      </span>
                      <span class="review-date"><i class="far fa-calendar-alt me-1"></i>{{ review.created_at|date:"F j, Y" }}</span>
                    </div>
                  </div>
                </div>

                <!-- Place Information Section -->
                <h3 class="section-title">
                  <i class="fas fa-info-circle me-2"></i>Place Information
                </h3>
                <div id="selected-place-card" class="selected-place-card">
                  <div class="place-content-layout">
                    <div id="selected-place-photo-container" class="place-photo-container">
                      {% if review.place_photo_url %}
                        <img id="selected-place-photo" class="place-photo" src="{{ review.place_photo_url }}" alt="Place photo">
                      {% else %}
                        <img id="selected-place-photo" class="place-photo" src="https://via.placeholder.com/400x200?text=No+Image+Available" alt="Place photo">
                      {% endif %}
                    </div>
                    <div class="place-info-content">
                      <div class="place-header">
                        <h4 id="selected-place-name" class="place-title">{{ review.place_name }}</h4>
                        {% if review.place_rating %}
                        <div id="selected-place-rating" class="place-rating-display">
                          <i class="fas fa-star"></i> {{ review.place_rating }}{% if review.place_rating_count %} ({{ review.place_rating_count }}){% endif %}
                        </div>
                        {% endif %}
                      </div>
                      <div class="place-details-grid">
                        <div class="place-detail">
                          <i class="fas fa-map-marker-alt"></i>
                          <span id="selected-place-address">{{ review.location }}</span>
                        </div>
                        {% if review.place_website %}
                        <div class="place-detail" id="selected-place-website-container">
                          <i class="fas fa-globe"></i>
                          <a id="selected-place-website" href="{{ review.place_website }}" target="_blank">{{ review.place_website|cut:'https://'|cut:'http://'|cut:'/' }}</a>
                        </div>
                        {% endif %}
                        {% if review.place_phone %}
                        <div class="place-detail" id="selected-place-phone-container">
                          <i class="fas fa-phone"></i>
                          <span id="selected-place-phone">{{ review.place_phone }}</span>
                        </div>
                        {% endif %}
                        <div class="place-detail">
                          <i class="fas fa-tag"></i>
                          <div id="selected-place-types" class="place-tags">
                            {% for tag in review.place_tags %}
                              <span class="place-tag">{{ tag }}</span>
                            {% empty %}
                              <span class="text-muted">No categories available</span>
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Rating Section -->
                <div class="review-ratings-section">
                  <h3 class="section-title">Ratings</h3>
                  
                  <div class="rating-grid">
                    <div class="rating-item">
                      <div class="rating-name">Food</div>
                      <div class="rating-stars">
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.food_rating %}
                            <i class="fas fa-star"></i>
                          {% else %}
                            <i class="far fa-star"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <div class="rating-value">{{ review.food_rating }}/5</div>
                    </div>
                    
                    <div class="rating-item">
                      <div class="rating-name">Ambience</div>
                      <div class="rating-stars">
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.ambience_rating %}
                            <i class="fas fa-star"></i>
                          {% else %}
                            <i class="far fa-star"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <div class="rating-value">{{ review.ambience_rating }}/5</div>
                    </div>
                    
                    <div class="rating-item">
                      <div class="rating-name">Value</div>
                      <div class="rating-stars">
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.value_rating %}
                            <i class="fas fa-star"></i>
                          {% else %}
                            <i class="far fa-star"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <div class="rating-value">{{ review.value_rating }}/5</div>
                    </div>
                    
                    <div class="rating-item">
                      <div class="rating-name">Service</div>
                      <div class="rating-stars">
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.service_rating %}
                            <i class="fas fa-star"></i>
                          {% else %}
                            <i class="far fa-star"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <div class="rating-value">{{ review.service_rating }}/5</div>
                    </div>
                    
                    <div class="rating-item overall">
                      <div class="rating-name">Overall</div>
                      <div class="rating-stars">
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.overall_rating %}
                            <i class="fas fa-star"></i>
                          {% else %}
                            <i class="far fa-star"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <div class="rating-value">{{ review.overall_rating }}/5</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Review Content -->
          <div class="review-content-section">
            <h3 class="section-title">Review</h3>
            <div class="review-content">
              {{ review.content|linebreaks }}
            </div>
            
            <!-- User Uploaded Photo Section -->
            {% if review.image %}
            <div class="user-photo-section mt-4">
              <div class="user-photo-container">
                <img src="{{ review.image.url }}" alt="Photo from {{ review.place_name }}" class="user-photo">
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Review Modal -->
{% if user.is_staff or user.is_superuser %}
<div class="modal fade" id="deleteReviewModal" tabindex="-1" aria-labelledby="deleteReviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title text-danger" id="deleteReviewModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Delete Review
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Are you sure you want to delete your review of <strong>"{{ review.place_name }}"</strong>?</p>
        
        <div class="d-flex align-items-center mb-3 p-3 bg-light rounded">
          <div class="flex-shrink-0 me-3">
            {% if review.place_photo_url %}
              <img src="{{ review.place_photo_url }}" alt="{{ review.place_name }}" class="img-fluid rounded" style="width: 80px; height: 80px; object-fit: cover;">
            {% else %}
              <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                <i class="fas fa-utensils fa-2x text-white"></i>
              </div>
            {% endif %}
          </div>
          <div>
            <h6 class="mb-1">{{ review.place_name }}</h6>
            <div class="text-muted small">{{ review.location }}</div>
            <div class="mt-1">
              {% for i in "12345" %}
                {% if forloop.counter <= review.overall_rating %}
                  <i class="fas fa-star text-warning"></i>
                {% else %}
                  <i class="far fa-star text-warning"></i>
                {% endif %}
              {% endfor %}
              <span class="ms-1">({{ review.overall_rating }}/5)</span>
            </div>
          </div>
        </div>
        
        <div class="alert alert-warning">
          <i class="fas fa-info-circle me-2"></i>
          This action cannot be undone. The review will be permanently deleted.
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{% url 'delete_review' review.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash me-1"></i>Delete Review
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
.review-detail-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  overflow: hidden;
  margin-bottom: 3rem;
  border: 1px solid #f1f3f4;
}

.review-image-section {
  height: 100%;
  min-height: 400px;
  position: relative;
}

.review-main-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.review-info-section {
  padding: 2.5rem;
  height: 100%;
}

.review-title-section {
  border-bottom: 2px solid #f1f3f4;
  padding-bottom: 1.5rem;
}

.review-card-title {
  color: #5d4f41;
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.75rem;
  line-height: 1.2;
}

.reviewer-info {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-top: 0.5rem;
  background-color: #f8f9fa;
  padding: 0.75rem 1rem;
  border-radius: 12px;
  border-left: 3px solid #D2691E;
}

.reviewer-avatar {
  font-size: 2rem;
  color: #8B4513;
  background-color: #FFF8E1;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.reviewer-avatar i {
  font-size: 1.5rem;
}

.reviewer-details {
  display: flex;
  flex-direction: column;
}

.reviewer-name {
  font-weight: 600;
  color: #495057;
  font-size: 1.1rem;
}

.review-date {
  color: #6c757d;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  margin-top: 0.2rem;
}

.review-subtitle {
  color: #6c757d;
  font-size: 1.2rem;
  font-weight: 500;
}

.review-meta-section {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  border-left: 4px solid #8B4513;
}

.meta-item {
  display: flex;
  align-items: flex-start;
  margin-bottom: 1rem;
  gap: 0.75rem;
}

.meta-item:last-child {
  margin-bottom: 0;
}

.meta-item i {
  margin-top: 0.125rem;
  color: #8B4513;
}

.meta-label {
  font-weight: 600;
  color: #6c757d;
  min-width: 120px;
}

.meta-value {
  color: #495057;
  font-weight: 500;
  flex: 1;
}

.section-title {
  color: #8B4513;
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 1.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 3px solid #D2691E;
  display: inline-block;
}

.review-ratings-section {
  margin-bottom: 3rem;  /* Increased from 2rem to add more space */
}

.rating-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}

.rating-item {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1rem;
  border: 1px solid #e9ecef;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.rating-item.overall {
  grid-column: span 2;
  background: #FFF8E1;
  border-color: #FFE082;
}

.rating-name {
  font-weight: 600;
  color: #495057;
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
}

.rating-stars {
  color: #FFD700;
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
  letter-spacing: 0.15rem;
}

.rating-value {
  font-weight: 700;
  color: #212529;
  font-size: 1.1rem;
}

.review-content-section {
  padding: 0 2.5rem 2.5rem;
}

.review-content {
  line-height: 1.8;
  color: #495057;
  font-size: 1.1rem;
}

.user-photo-section {
  margin-top: 2rem;
}

.user-photo-container {
  text-align: center;
  max-width: 500px;
  margin: 0 auto;
}

.user-photo {
  max-width: 100%;
  height: auto;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

/* Place Card Styles from add_review.html */
.selected-place-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 1.5rem;
  border: 1px solid #e9ecef;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.place-content-layout {
  display: flex;
  gap: 1rem;
}

.place-info-content {
  flex: 1;
}

.place-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
}

.place-title {
  margin: 0;
  font-size: 1.5rem;
  color: #212529;
  font-weight: 700;
}

.place-rating-display {
  background: #fff3cd;
  color: #856404;
  border-radius: 50px;
  padding: 0.25rem 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-weight: 600;
}

.place-rating-display i {
  color: #ffc107;
}

.place-details-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.place-detail {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
}

.place-detail i {
  color: #6c757d;
  margin-top: 0.25rem;
}

.place-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.place-tag {
  background: #e9ecef;
  color: #495057;
  border-radius: 50px;
  padding: 0.2rem 0.6rem;
  font-size: 0.8rem;
  white-space: nowrap;
}

.place-photo-container {
  width: 180px;
  height: 180px;
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0;
}

.place-photo {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

/* Responsive Adjustments */
@media (max-width: 991.98px) {
  .review-image-section {
    min-height: 300px;
  }
  
  .review-info-section {
    padding: 1.5rem;
  }
  
  .rating-grid {
    grid-template-columns: 1fr;
  }
  
  .rating-item.overall {
    grid-column: span 1;
  }
  
  .review-content-section {
    padding: 0 1.5rem 1.5rem;
  }
}

@media (max-width: 576px) {
  .place-content-layout {
    flex-direction: column;
  }
  
  .place-photo-container {
    width: 100%;
    height: auto;
    max-height: 200px;
    margin-bottom: 1rem;
  }

  .place-details-grid {
    grid-template-columns: 1fr;
  }
  
  .place-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .place-rating-display {
    margin-top: 0.5rem;
  }
}
</style>
{% endblock %}