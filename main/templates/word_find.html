{% extends 'base.html' %}
{% block title %}Word Find | Ben's Breads{% endblock %}
{% block content %}
<div class="container">
    <div id="game-loader" style="display:flex;align-items:center;justify-content:center;height:350px;">
        <div class="loading-spinner" style="font-size:2rem; flex-direction:column; align-items:center; gap:1rem;">
            <i class="fas fa-bread-slice fa-spin" style="color:#8B4513; font-size:3rem;"></i>
            <div style="font-family:'Montserrat',sans-serif; font-size:1.5rem; font-weight:600; color:#8B4513; letter-spacing:1px;">
                Loading Game...
            </div>
            <!-- Spinning bread SVG below the text -->
            <div style="margin-top:0.5rem;">
                <svg width="48" height="48" viewBox="0 0 48 48" style="animation: spin-bread 1.2s linear infinite;">
                    <ellipse cx="24" cy="32" rx="14" ry="10" fill="#DEB887" stroke="#8B4513" stroke-width="2"/>
                    <ellipse cx="24" cy="22" rx="16" ry="12" fill="#F5DEB3" stroke="#8B4513" stroke-width="2"/>
                    <ellipse cx="24" cy="18" rx="12" ry="8" fill="#fff8dc" stroke="#8B4513" stroke-width="1.5"/>
                </svg>
            </div>
        </div>
    </div>
    <div id="main-container" style="display:none;">
        <h1 class="game-title">Word Find</h1>
        <div id="game-container">
            <div class="game-layout">
                <div class="info-container">
                    <div id="score-container" class="info-box">
                        <p>Score:</p>
                        <p id="score" class="info-value">0</p>
                    </div>
                    <div id="timer-container" class="info-box">
                        <p>Time:</p>
                        <p id="timer" class="info-value">90</p>
                    </div>
                </div>
                <!-- Set a fixed height and style for feedback-message to prevent shifting -->
                <div id="feedback-message" class="feedback-message" style="min-height:1.4em; height:1.4em; display:flex; align-items:center; justify-content:center; margin-bottom:0;"></div>
                <!-- Prevent shifting by setting a fixed height and overflow for the word row -->
                <div id="current-word-row" style="margin: 6px 0; min-height: 1.6em; display: flex; align-items: center; justify-content: center;">
                    <p class="current-word-display" id="current-word" style="margin:0; min-height:1.4em; max-width:100vw; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:1.1rem;"></p>
                </div>
                <div id="grid" class="grid"></div>
                <div id="submit-word-row" style="margin: 15px 0;">
                    <button id="submit-word" class="btn hidden">Submit</button>
                </div>
            </div>
            <div id="current-word-container" style="display:none;"></div>
            <div class="button-container">
                <button id="start-game" class="btn">New Game</button>
                <button id="leaderboard-button" class="btn" data-bs-toggle="modal" data-bs-target="#leaderboardModal">Leaderboard</button>
                <button id="how-to-play-button" class="btn" data-bs-toggle="modal" data-bs-target="#howToPlayModal">How to Play</button>
            </div>
        </div>
        <!-- Leaderboard Modal -->
        <div class="modal fade" id="leaderboardModal" tabindex="-1" aria-labelledby="leaderboardModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content game-modal">
                    <div class="modal-header">
                        <h5 class="modal-title text-warning" id="leaderboardModalLabel">
                            <i class="fas fa-trophy me-2"></i>
                            Leaderboard
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="leaderboardContent" class="table-responsive">
                            <table class="table table-game">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardTableBody">
                                    <tr>
                                        <td colspan="2" class="text-center">
                                            <div class="loading-spinner">
                                                <i class="fas fa-spinner fa-spin"></i>
                                                Loading...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- How to Play Modal -->
        <div class="modal fade" id="howToPlayModal" tabindex="-1" aria-labelledby="howToPlayModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content game-modal">
                    <div class="modal-header">
                        <h5 class="modal-title" id="howToPlayModalLabel">
                            <i class="fas fa-question-circle me-2"></i>
                            How to Play
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul>
                            <li>Select letters by clicking on them to form a word.</li>
                            <li>Words must be valid and connected sequentially.</li>
                            <li>Submit your word using the "Submit" button.</li>
                            <li>Earn points based on the length of valid words.</li>
                            <li>The game ends when the timer runs out.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Loading overlay -->
<!-- <div id="loading-overlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.95);">
    <div class="loading-spinner" style="font-size:2rem;">
        <i class="fas fa-spinner fa-spin"></i>
        Loading dictionary...
    </div>
</div> -->
<!-- Use the popular-english-words library for a more game-appropriate word list -->
<script type="module">
    import { words } from 'https://cdn.jsdelivr.net/npm/popular-english-words@1.0.2/index.js';
    window.all_words = words.getMostPopular(60000);
    // Hide loader and show game after dictionary is loaded
    window.addEventListener('DOMContentLoaded', function() {
        document.getElementById('game-loader').style.display = 'none';
        document.getElementById('main-container').style.display = '';
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const grid = document.getElementById('grid');
    const scoreElement = document.getElementById('score');
    const timerElement = document.getElementById('timer');
    const submitButton = document.getElementById('submit-word');
    const startButton = document.getElementById('start-game');
    const leaderboardButton = document.getElementById('leaderboard-button');
    const howToPlayButton = document.getElementById('how-to-play-button');
    const leaderboardTableBody = document.getElementById('leaderboardTableBody');
    const currentWordElement = document.getElementById('current-word');
    const feedbackMessage = document.getElementById('feedback-message');
    const leaderboardModal = document.getElementById('leaderboardModal');

    let score = 0;
    let timeRemaining = 90;
    let gridLetters = [];
    let timerInterval;
    let currentWord = '';
    let selectedCells = [];
    let gameActive = true;
    let usedWords = []; // Track used words in the current round

    // Use the popular-english-words library for validation
    // The global variable 'popularWords' is provided by the CDN above
    // We'll use a Set for fast lookup

    const WORD_SET = new Set(typeof all_words !== "undefined" ? all_words : []);

    function generateGrid() {
        grid.innerHTML = '';
        gridLetters = [];
        for (let i = 0; i < 25; i++) { // Generate 25 cells for a 5x5 grid
            const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
            gridLetters.push(letter);
            const cell = document.createElement('div');
            cell.classList.add('grid-cell');
            cell.textContent = letter;
            cell.dataset.index = i; // Store the cell's index
            cell.addEventListener('click', () => selectCell(cell));
            grid.appendChild(cell);
        }
    }

    function getNeighbors(index) {
        const neighbors = [];
        const row = Math.floor(index / 5);
        const col = index % 5;

        // Check all possible neighbors
        const directions = [
            [-1, -1], [-1, 0], [-1, 1],
            [0, -1],          [0, 1],
            [1, -1], [1, 0], [1, 1]
        ];

        directions.forEach(([dx, dy]) => {
            const newRow = row + dx;
            const newCol = col + dy;
            if (newRow >= 0 && newRow < 5 && newCol >= 0 && newCol < 5) {
                neighbors.push(newRow * 5 + newCol);
            }
        });

        return neighbors;
    }

    function selectCell(cell) {
        if (!gameActive) return; // Disable selection if the game is inactive
        const index = parseInt(cell.dataset.index, 10);

        // If the cell is already selected, deselect it and all following cells
        const selectedIndex = selectedCells.indexOf(index);
        if (selectedIndex !== -1) {
            selectedCells.slice(selectedIndex).forEach(idx => {
                const deselectCell = grid.children[idx];
                deselectCell.classList.remove('selected');
            });
            selectedCells = selectedCells.slice(0, selectedIndex);
            currentWord = currentWord.slice(0, selectedIndex);
            currentWordElement.textContent = currentWord;
            return;
        }

        // Check if the cell is a neighbor of the last selected cell
        if (selectedCells.length === 0 || getNeighbors(selectedCells[selectedCells.length - 1]).includes(index)) {
            selectedCells.push(index);
            currentWord += cell.textContent;
            currentWordElement.textContent = currentWord;
            cell.classList.add('selected');
        }
    }

    function resetSelection() {
        selectedCells.forEach(index => {
            const cell = grid.children[index];
            cell.classList.remove('selected');
        });
        selectedCells = [];
        currentWord = '';
        currentWordElement.textContent = '';
    }

    function updateLeaderboard() {
        leaderboardTableBody.innerHTML = '<tr><td colspan="2" class="text-center"><div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div></td></tr>';
        fetch('/api/word-find-leaderboard/')
            .then(res => res.json())
            .then(data => {
                leaderboardTableBody.innerHTML = '';
                data.leaderboard.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${entry.user}</td><td>${entry.score}</td>`;
                    leaderboardTableBody.appendChild(row);
                });
            })
            .catch(() => {
                leaderboardTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Failed to load leaderboard</td></tr>';
            });
    }

    function saveResult() {
        // Use setTimeout to ensure UI updates before network request (fixes some mobile browsers)
        setTimeout(function() {
            fetch('/api/save-word-find-result/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || ''
                },
                body: JSON.stringify({
                    score: score,
                    timeRemaining: 0
                }),
                credentials: 'include'
            })
            .then(res => {
                // If redirected to login (302), show a message or handle gracefully
                if (res.redirected && res.url.includes('/accounts/login')) {
                    feedbackMessage.textContent = 'Log in to save your score to the leaderboard!';
                    feedbackMessage.classList.remove('green', 'red');
                    feedbackMessage.classList.add('red');
                    updateLeaderboard();
                    return;
                }
                return res.json();
            })
            .then(data => {
                if (data) updateLeaderboard();
            })
            .catch(err => {
                updateLeaderboard();
                console.error('Error saving result:', err);
            });
        }, 100);
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeRemaining--;
            timerElement.textContent = timeRemaining;
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                feedbackMessage.textContent = 'Time is up!';
                feedbackMessage.classList.add('red');
                gameActive = false;
                resetSelection();
                submitButton.classList.add('hidden');
                saveResult(); // Save the result only at the end of the game
            }
        }, 1000);
    }

    function startGame() {
        score = 0;
        timeRemaining = 90; // Reset game time to 90 seconds
        gameActive = true; // Enable selection
        scoreElement.textContent = score;
        timerElement.textContent = timeRemaining;
        submitButton.classList.remove('hidden');
        feedbackMessage.textContent = '';
        feedbackMessage.classList.remove('red', 'green');
        resetSelection();
        generateGrid();
        startTimer();
        updateLeaderboard(); // Ensure leaderboard is refreshed at the start of a new game
        usedWords = []; // Reset used words for a new round
    }

    // Add both click and touchstart event listeners for submit button
    function handleSubmit(event) {
        event.preventDefault();
        event.stopPropagation();

        if (!currentWord || !gameActive) return;

        if (usedWords.includes(currentWord)) {
            feedbackMessage.textContent = 'Word already used!';
            feedbackMessage.classList.add('red');
            resetSelection();
            return;
        }

        feedbackMessage.classList.remove('red', 'green');

        // Use the popular words set for validation (case-insensitive)
        if (WORD_SET.has(currentWord.toLowerCase())) {
            score += currentWord.length;
            scoreElement.textContent = score;
            feedbackMessage.textContent = `${currentWord} (+${currentWord.length})`;
            feedbackMessage.classList.add('green');
            usedWords.push(currentWord);
        } else {
            feedbackMessage.textContent = 'Invalid word!';
            feedbackMessage.classList.add('red');
        }
        resetSelection();
    }

    submitButton.addEventListener('click', handleSubmit);
    submitButton.addEventListener('touchstart', handleSubmit);

    startButton.addEventListener('click', startGame);
    leaderboardModal.addEventListener('show.bs.modal', updateLeaderboard);

    updateLeaderboard();
});
</script>
<style>
@keyframes spin-bread {
    100% { transform: rotate(360deg);}
}

.container {
    text-align: center;
    margin-top: 20px;
}
.game-title {
    font-size: 2.5rem;
    font-weight: bold;
    color: #212529; /* Dark gray for title */
    text-transform: uppercase;
    margin-bottom: 20px;
    border-bottom: 5px solid; /* Restore underline bar */
    border-image: linear-gradient(90deg, #8B4513 0%, #D2691E 50%, #DEB887 100%) 1; /* Apply gradient to border */
    display: inline-block;
}
.game-layout {
    display: flex;
    flex-direction: column; /* Stack elements vertically */
    align-items: center; /* Center elements horizontally */
    gap: 20px; /* Space between score, timer, and grid */
    margin-top: 20px; /* Add spacing below the title */
}

.info-container {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 10px;
    width: 100%;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.info-box {
    flex: 1;
    padding: 10px 5px; /* Reduce padding for mobile */
    background-color: #ffffff;
    color: #212529;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #dee2e6;
    min-width: 0;
}

.info-box p {
    margin: 0;
    font-size: 1em;
    line-height: 1.1;
}

.info-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: #8B4513;
    word-break: break-all;
}

@media (max-width: 768px) {
    .info-container {
        max-width: none;
        gap: 6px;
    }
    .info-box {
        padding: 6px 2px; /* Even smaller padding for mobile */
        font-size: 0.95em;
        min-width: 0;
    }
    .info-value {
        font-size: 1rem;
    }
    .game-layout {
        gap: 10px;
    }
    #current-word-row {
        min-height: 1.4em;
    }
    .current-word-display {
        font-size: 1rem;
        min-height: 1.2em;
    }
}

/* Prevent shifting of grid/buttons when word is being formed */
#current-word-row {
    min-height: 1.6em;
    box-sizing: border-box;
    /* Ensures space is always reserved for the word */
}

.current-word-display {
    font-size: 1.1rem;
    font-weight: bold;
    color: #212529;
    margin-bottom: 0;
    min-height: 1.4em;
    max-width: 100vw;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    transition: color 0.2s;
}

.grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 10px;
    width: 90%; /* Make the grid take up most of the screen width */
    max-width: 400px; /* Limit maximum width */
    height: auto; /* Allow height to adjust dynamically */
    aspect-ratio: 1; /* Maintain square shape */
    background-color: #f8f9fa; /* Light gray background */
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}
.grid-cell {
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #dee2e6; /* Light gray border */
    font-size: 1.2rem; /* Adjust font size for smaller screens */
    font-weight: bold;
    text-transform: uppercase;
    cursor: pointer;
    background-color: #ffffff; /* White background for cells */
    border-radius: 50%; /* Circular cells */
    transition: background-color 0.2s, border-color 0.2s;
}
.grid-cell.selected {
    background-color: #ffdd44; /* Yellow background for selected cells */
    border-color: #ffaa00; /* Dark yellow border for selected cells */
}
.feedback-message {
    margin-top: 10px;
    margin-bottom: 0;
    font-size: 1.1rem;
    font-weight: bold;
    text-align: center;
    min-height: 1.4em;
    height: 1.4em;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
}
.feedback-message.green {
    color: #28a745;
}
.feedback-message.red {
    color: #dc3545;
}
.btn {
    display: inline-block;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: bold;
    color: #ffffff; /* White text */
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}
.btn#submit-word {
    background: linear-gradient(135deg, #4a90e2, #357abd); /* Blue gradient for Submit */
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); /* Enhanced shadow */
}
.btn#submit-word:hover {
    background: linear-gradient(135deg, #357abd, #2c6fb0); /* Darker gradient on hover */
}
.btn#start-game {
    background: linear-gradient(135deg, #8B4513, #D2691E); /* Brown gradient for New Game */
}
.btn#start-game:hover {
    background: linear-gradient(135deg, #D2691E, #DEB887); /* Lighter gradient on hover */
}
.btn#leaderboard-button {
    background: linear-gradient(135deg, #6c757d, #495057); /* Gray gradient for Leaderboard */
}
.btn#leaderboard-button:hover {
    background: linear-gradient(135deg, #495057, #343a40); /* Darker gradient on hover */
}
.btn#how-to-play-button {
    background: linear-gradient(135deg, #17a2b8, #138496); /* Blue gradient for How to Play */
}
.btn#how-to-play-button:hover {
    background: linear-gradient(135deg, #138496, #0d6efd); /* Darker blue gradient on hover */
}
.btn:disabled {
    background-color: #6c757d; /* Gray for disabled buttons */
    cursor: not-allowed;
}
.button-container {
    margin-top: 30px;
}
.hidden {
    display: none;
}
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
}
.loading-spinner i {
    margin-right: 5px;
}
.table-game {
    width: 100%;
    margin: 0;
    border-collapse: collapse;
}
.table-game th, .table-game td {
    padding: 10px;
    text-align: center;
    border: 1px solid #dee2e6;
}
.table-game th {
    background-color: #f1f1f1;
    font-weight: bold;
}
.table-game td {
    background-color: #ffffff;
}
.table-game tr:hover {
    background-color: #f9f9f9;
}
.game-modal {
    border-radius: 12px;
    overflow: hidden;
}
.modal-header {
    background-color: #343a40;
    color: #ffffff;
    border-bottom: 1px solid #dee2e6;
}
.modal-title {
    font-size: 1.5rem;
    font-weight: bold;
}
.btn-close {
    background: none;
    border: none;
    color: #ffffff;
    font-size: 1.2rem;
}
.btn-close:hover {
    color: #dc3545;
}
.modal-body {
    padding: 20px;
}
.modal-body ul {
    list-style-type: none;
    padding: 0;
}
.modal-body li {
    margin-bottom: 10px;
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .game-layout {
        flex-direction: column; /* Stack elements vertically */
        gap: 15px; /* Reduce spacing for smaller screens */
    }

    .info-container {
        flex-direction: row; /* Keep score and timer side by side on smaller screens */
        gap: 15px; /* Reduce spacing for smaller screens */
    }

    .info-box {
        width: 95%; /* Fill most of the screen width on mobile */
        max-width: 350px; /* Cap the maximum width */
    }

    .grid {
        width: 100%; /* Make the grid take up the full screen width */
        max-width: 100%; /* Remove maximum width restriction */
    }
}
</style>
{% endblock %}
